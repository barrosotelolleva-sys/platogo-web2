<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PlatoÂ¡GO! - Foto â†’ Plato</title>
  <style>
   @keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}
.camera-btn:active { transform: scale(0.95); } 
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #A0DDE6 0%, #B2F7C9 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      text-align: center;
      max-width: 400px;
      width: 100%;
    }
    h1 {
      font-size: clamp(2.5rem, 8vw, 4rem);
      font-weight: 900;
      background: linear-gradient(45deg, #228B22, #39FF14);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    .subtitle {
      font-size: 1.2rem;
      color: #006400;
      margin-bottom: 40px;
    }
    .camera-btn {
      background: linear-gradient(45deg, #228B22, #39FF14);
      color: white;
      border: none;
      padding: 20px 40px;
      font-size: 1.5rem;
      font-weight: 700;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(34,139,34,0.4);
      transition: all 0.3s;
    }
    .camera-btn:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(34,139,34,0.6);
    }
    .preview {
      margin-top: 30px;
      max-width: 100%;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>PlatoÂ¡GO!</h1>
    <p class="subtitle">Foto a la nevera â†’ Â¡Plato ya!</p>
    
    <button class="camera-btn" onclick="openCamera()">
      TOMAR FOTO
      </button>
     <button class="camera-btn" onclick="openCamera('pantry')" style="margin-left:10px; background:linear-gradient(45deg, #8B4513, #D2691E);">
      FOTO A LA DESPENSA 
    </button>
    
    <img id="preview" class="preview" style="display:none;">
  </div>

<script>
  let stream;
  let ingredientsES = []; // â† ÃšNICO Y GLOBAL
  // TUS CLAVES (PEGA AQUÃ)
  const GEMINI_API_KEY = 'AIzaSyC9PmhuhJLhl8Bf1yO5J0hQAJC4PJCjnlc'; // â† TU CLAVE GEMINI
  const SPOONACULAR_KEY = 'fb1bcb51f67e4c7d8d709f610c3254d1'; // â† TU CLAVE SPOONACULAR (si la tienes)

  async function openCamera(mode = 'fridge') {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      const video = document.createElement('video');
      video.srcObject = stream;
      video.play();

      setTimeout(async () => {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
        canvas.getContext('2d').drawImage(video, 0, 0);

        const img = document.getElementById('preview');
        img.src = canvas.toDataURL('image/jpeg');
        img.style.display = 'block';
        stream.getTracks().forEach(track => track.stop());

        const loading = document.createElement('p');
        
        loading.id = 'loading';
        loading.innerHTML = 'Â¡Plato<span style="color:#FF4500;">Â¡GO GO GO!</span>';
        loading.style.fontWeight = '700';
        loading.style.fontSize = '1.1em';
        loading.style.color = '#228B22';
        loading.style.marginTop = '20px';
        document.querySelector('.container').appendChild(loading);

        // === AÃ‘ADE AQUÃ EL PROMPT DINÃMICO ===
      const promptText = mode === 'pantry' 
        ? "Analiza esta foto de despensa. Detecta arroz, pasta, legumbres, conservas, aceite, especias. Responde: 'DetectÃ©: lista en espaÃ±ol separada por comas'."
        : "Analiza esta foto de nevera espaÃ±ola. Detecta alimentos y envases. Responde solo: 'DetectÃ©: lista en espaÃ±ol separada por comas'.";
      // === FIN ===
        const base64 = canvas.toDataURL('image/jpeg').split(',')[1];

        try {
          // MODELO ACTUAL: gemini-2.5-flash (2025, soporta imÃ¡genes + espaÃ±ol)
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{
                parts: [
                  {
                    text: promptText
                  },
                  {
                    inline_data: {
                      mime_type: 'image/jpeg',
                      data: base64
                    }
                  }
                ]
              }]
            })
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
          }

          const data = await response.json();
          const analysis = data.candidates[0].content.parts[0].text;

          // === LLENAR ingredientsES GLOBAL ===
const detectedMatch = analysis.match(/DetectÃ©: (.+)/);
if (detectedMatch) {
  ingredientsES = detectedMatch[1].split(',').map(i => i.trim().toLowerCase()).filter(Boolean);
} else {
  ingredientsES = [];
}
// === FIN LLENADO ===
          
          document.getElementById('loading').remove();

          if (ingredientsES.length > 0) {
            const result = document.createElement('div');
            result.innerHTML = `
              <p style="margin-top:20px; font-weight:700; color:#228B22;">
                ${analysis}
              </p>
            `;
            document.querySelector('.container').appendChild(result);
   // === MOSTRAR CHAT DESPUÃ‰S DE DETECTAR ===
if (ingredientsES.length > 0) {
  showChat();
}
// === FIN CHAT ===         
// Mostrar chat despuÃ©s de detectar
showChat();
            const recipeBtn = document.createElement('button');
            recipeBtn.className = 'camera-btn';
            recipeBtn.style.marginTop = '20px';
            recipeBtn.style.background = 'linear-gradient(45deg, #FF4500, #FF8C00)';
            recipeBtn.innerHTML = 'SUGERIR PLATO';
            recipeBtn.onclick = () => suggestRecipe(ingredientsES);
            document.querySelector('.container').appendChild(recipeBtn);
// Mostrar chat despuÃ©s de detectar ingredientes
ingredientsES = detected.split(',').map(i => i.trim()).filter(Boolean);
showChat();
          } else {
            const result = document.createElement('div');
            result.innerHTML = `
              <p style="margin-top:20px; color:#DAA520;">
                No detectÃ© alimentos ğŸ˜…<br>
                <small>Prueba con mÃ¡s luz</small>
              </p>
            `;
            document.querySelector('.container').appendChild(result);
            
          }

        } catch (err) {
          document.getElementById('loading').remove();
          alert(`Error en Gemini: ${err.message}`);
          console.error(err);
        }

      }, 3000);

    } catch (err) {
      alert('CÃ¡mara no disponible');
    }
  }

  // RECETA CON SPOONACULAR
async function suggestRecipe(ingredientsES) {
  const query = ingredientsES.join(',');
  const loading = document.createElement('p');
  loading.id = 'recipe-loading';
  loading.innerHTML = 'Buscando recetas con lo que TÃš TIENES...';
  loading.style.color = '#FF4500';
  document.querySelector('.container').appendChild(loading);

  try {
    const response = await fetch(`https://api.spoonacular.com/recipes/findByIngredients?ingredients=${query}&number=6&ranking=2&ignorePantry=true&apiKey=${SPOONACULAR_KEY}&language=es`);
    const recipes = await response.json();
    document.getElementById('recipe-loading').remove();

    // Filtra: solo recetas con 0 o 1 ingrediente faltante
    const validRecipes = recipes.filter(r => r.missedIngredientCount <= 1);

    if (validRecipes.length > 0) {
      for (const r of validRecipes.slice(0, 3)) {
        const missed = r.missedIngredients.map(i => i.name).join(', ') || 'nada';
        const used = r.usedIngredients.map(i => i.name).join(', ');

        // Traduce tÃ­tulo con Gemini
        const tituloES = await traducirTitulo(r.title);

        const card = document.createElement('div');
        card.style = 'margin:15px 0; padding:18px; background:#fff; border-radius:18px; box-shadow:0 6px 20px rgba(0,0,0,0.12); font-family: system-ui;';

        const pregunta = r.missedIngredientCount > 0
          ? `<p style="color:#DAA520; font-weight:600; margin-top:10px; font-style:italic;">
               Â¿Tienes <strong>${missed}</strong>? Â¡Vamos, que lo hacemos!
             </p>`
          : `<p style="color:#228B22; font-weight:700; margin-top:10px;">
               Â¡Tienes TODO! Â¡A la sartÃ©n!
             </p>`;

        card.innerHTML = `
          <h4 style="color:#FF4500; margin:0 0 10px; font-size:1.1em;">${tituloES}</h4>
          <p style="margin:5px 0; color:#333;"><strong>Usa:</strong> ${used}</p>
          <p style="margin:5px 0; color:#666;"><strong>Falta:</strong> ${missed || 'Â¡nada!'}</p>
          ${pregunta}
        `;
        document.querySelector('.container').appendChild(card);
      }
    } else {
      const noRecipe = document.createElement('div');
      noRecipe.style = 'margin:20px 0; padding:15px; background:#fff; border-radius:15px; text-align:center;';
      noRecipe.innerHTML = `
        <p style="color:#DAA520; font-weight:700; margin:0;">
          Â¡No encontrÃ© receta perfecta! ğŸ˜…<br>
          <small style="color:#777;">Pero puedes hacer: <strong>macedonia, gazpacho, bocata...</strong></small>
        </p>
      `;
      document.querySelector('.container').appendChild(noRecipe);
    }
  } catch (err) {
    document.getElementById('recipe-loading')?.remove();
    alert('Error al buscar receta');
  }
} 


async function sendChat() {
  const input = document.getElementById('chat-input');
  const message = input.value.trim().toLowerCase();
  if (!message) return;

  addMessage(message, 'user');
  input.value = '';

  // Si no hay ingredientes, no responde
  if (ingredientsES.length === 0) {
    addMessage("Primero haz una foto a la nevera, Â¡vamos!", 'bot');
    return;
  }

  // Prompt ultra-claro
  const prompt = `
Tienes ESTOS ingredientes EXACTOS (nada mÃ¡s): ${ingredientsES.join(', ')}.
El usuario dice: "${message}".
Responde COMO UN AMIGO DEL BARRIO: vacilÃ³n, directo, sin formalismos.
Usa SÃ“LO lo que tienes. NO inventes. Nada de "proceda", "aÃ±ada", "sirva".
Si no puedes hacer nada, di: "Con eso, mejor una macedonia o un bocata simple".
Ejemplos reales:
- "Â¡Echa un chorro de aceite, que no somos pobres!"
- "Â¡Corta todo como puedas, total se come igual!"
- "Â¡TÃ­ralo todo junto, remueve y a zampar!"
- "Â¡No tienes pan? Pues fruta a mordiscos, Â¡vamos!"
- "Corta el tomate, mÃ©telo en el pan, Â¡y a morder!"
- "Â¡Tira todo en un bol, mÃ©zclalo y a disfrutar!"
- "Â¡Con eso no se hace nada, pero un bocata nunca falla!"
- Si tiene "tomate" y "pan" â†’ "Â¡Pan con tomate! Unta y a morder."
- Si tiene "plÃ¡tano", "manzana" â†’ "Â¡Macedonia! Corta y mezcla."
- Si no encaja â†’ "Con eso, mejor un bocata o fruta directa."
`.trim();

  try {
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }]
      })
    });
    const data = await res.json();
    const reply = data.candidates[0].content.parts[0].text.trim();
    addMessage(reply, 'bot');
  } catch (err) {
    addMessage("Â¡Uy! Error de red... Â¿bocata?", 'bot');
    console.error(err);
  }
}

function addMessage(text, sender) {
  const messages = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.style = sender === 'user' 
    ? 'text-align:right; margin:8px 0;'
    : 'text-align:left; margin:8px 0;';
  div.innerHTML = `<span style="padding:10px 16px; border-radius:20px; display:inline-block; max-width:85%; font-size:0.95em; ${
    sender === 'user' ? 'background:#FF4500; color:white;' : 'background:#e0e0e0; color:#333;'
  }">${text}</span>`;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

// Mostrar chat cuando haya ingredientes
// === FUNCIÃ“N SHOWCHAT (AQUÃ) ===

// === CHAT: addMessage + showChat (PEGAR AQUÃ) ===
function addMessage(text, sender) {
  const messages = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.style = sender === 'user' 
    ? 'text-align:right; margin:8px 0;'
    : 'text-align:left; margin:8px 0;';
  div.innerHTML = `<span style="padding:10px 16px; border-radius:20px; display:inline-block; max-width:85%; font-size:0.95em; ${
    sender === 'user' ? 'background:#FF4500; color:white;' : 'background:#e0e0e0; color:#333;'
  }">${text}</span>`;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function showChat() {
  document.getElementById('chat-container').style.display = 'block';
  addMessage("Â¡Dime quÃ© quieres hacer! Ej: bocata, macedonia...", 'bot');

  // Sugerencia automÃ¡tica
  let sugerencia = '';
  const tieneFruta = ingredientsES.some(i => ['plÃ¡tano', 'manzana', 'pera', 'naranja', 'mandarina'].includes(i));
  const tieneVerdura = ingredientsES.some(i => ['tomate', 'pimiento', 'cebolla', 'ajo'].includes(i));
  const tienePan = ingredientsES.includes('pan') || ingredientsES.includes('pan de molde');

  if (tienePan && tieneVerdura) {
    sugerencia = 'Â¿Bocata con tomate y pimiento?';
  } else if (tieneFruta) {
    sugerencia = 'Â¿Macedonia con plÃ¡tano y manzana?';
  } else if (tieneVerdura) {
    sugerencia = 'Â¿Ensalada con tomate y pimiento?';
  } else {
    sugerencia = 'Â¿QuÃ© te apetece?';
  }

  setTimeout(() => addMessage(sugerencia, 'bot'), 1000);
}
// === FIN CHAT ===
</script>

</div>
<!-- === CHAT DE RECETAS (AQUÃ) === -->
<div id="chat-container" style="margin:30px 0 20px; display:none;">
  <div id="chat-messages" style="height:220px; overflow-y:auto; padding:15px; background:#f9f9f9; border-radius:18px; margin-bottom:12px; font-family:system-ui;"></div>
  <div style="display:flex; gap:8px;">
    <input type="text" id="chat-input" placeholder="Pide tu receta: bocata, macedonia..." style="flex:1; padding:14px; border-radius:14px; border:1px solid #ddd; font-size:1em;">
    <button onclick="sendChat()" style="padding:14px 18px; background:#FF4500; color:white; border:none; border-radius:14px; font-weight:700; cursor:pointer;">Â¡VAMOS!</button>
  </div>
</div>
<!-- === FIN CHAT === -->
<!-- === FIN CHAT === -->
</body>
</html>