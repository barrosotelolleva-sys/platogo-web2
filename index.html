<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plato¡GO! - Foto → Plato</title>
  <style>
   @keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}
@keyframes spin {
  to { transform: rotate(360deg); }
}
.gender-big-btn {
  margin: 10px;
  padding: 16px 32px;
  background: white;
  color: #FF4500;
  border: none;
  border-radius: 30px;
  font-weight: 700;
  font-size: 1.2em;
  cursor: pointer;
  transition: all 0.2s;
  min-width: 120px;
}

.gender-big-btn:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

.gender-big-btn.female { color: #FF69B4; }
.gender-big-btn.mix { color: #9C27B0; }
.camera-btn:active { transform: scale(0.95); } 
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #A0DDE6 0%, #B2F7C9 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      text-align: center;
      max-width: 400px;
      width: 100%;
    }
    h1 {
      font-size: clamp(2.5rem, 8vw, 4rem);
      font-weight: 900;
      background: linear-gradient(45deg, #228B22, #39FF14);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    .subtitle {
      font-size: 1.2rem;
      color: #006400;
      margin-bottom: 40px;
    }
    .camera-btn {
      background: linear-gradient(45deg, #228B22, #39FF14);
      color: white;
      border: none;
      padding: 20px 40px;
      font-size: 1.5rem;
      font-weight: 700;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(34,139,34,0.4);
      transition: all 0.3s;
    }
    .camera-btn:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(34,139,34,0.6);
    }
    .preview {
      margin-top: 30px;
      max-width: 100%;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
  
  
</style>
</head>
<body>
  <div class="container">
    <h1>Plato¡GO!</h1>
    <p class="subtitle">Foto a la nevera → ¡Plato ya!</p>
    
    <div style="display:flex; gap:12px; justify-content:center; margin:20px 0;">
  <button class="camera-btn" onclick="openCamera('fridge')" style="flex:1; background:linear-gradient(45deg, #00CED1, #20B2AA); color:white; border:none; padding:15px; border-radius:15px; font-weight:700; font-size:1.1em; cursor:pointer;">
    FOTO NEVERA
  </button>
  <button class="camera-btn" onclick="openCamera('pantry')" style="flex:1; background:linear-gradient(45deg, #8B4513, #D2691E); color:white; border:none; padding:15px; border-radius:15px; font-weight:700; font-size:1.1em; cursor:pointer;">
    FOTO DESPENSA
  </button>
    <img id="preview" class="preview" style="display:none;">
   
  </div>

<script>
  let stream;
  let ingredientsES = []; // ← ÚNICO Y GLOBAL
  let currentMode = 'fridge'; // ← NUEVA: nevera o despensa
  // TUS CLAVES (PEGA AQUÍ)
  const GEMINI_API_KEY = 'AIzaSyBbmMC4GMX2SDavB-RAlTaWf3zmvVFqRI4'; // ← TU CLAVE GEMINI
  const SPOONACULAR_KEY = 'fb1bcb51f67e4c7d8d709f610c3254d1'; // ← TU CLAVE SPOONACULAR (si la tienes)

  async function openCamera(mode = 'fridge') {
    currentMode = mode; // ← GUARDA: fridge o pantry
    // === MENSAJE DE ESPERA DEBAJO DE LOS BOTONES ===
  const waitMsg = document.createElement('div');
  waitMsg.id = 'wait-msg';
  waitMsg.innerHTML = `
    <small style="color:#666; font-size:0.8em; display:block; margin:10px auto; text-align:center; width:90%;">
      <span style="display:inline-block; width:12px; height:12px; border:2px solid #ccc; border-top:2px solid #FF4500; border-radius:50%; animation:spin 1s linear infinite; margin-right:6px; vertical-align:middle;"></span>
      Pulsa y espera 3 segundos...
    </small>
  `;
  document.querySelector('.container').appendChild(waitMsg);

  // === QUITAR MENSAJE EN 5 SEGUNDOS ===
  setTimeout(() => {
    const msg = document.getElementById('wait-msg');
    if (msg) msg.remove();
  }, 5000);
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      const video = document.createElement('video');
      video.srcObject = stream;
      video.play();

      setTimeout(async () => {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
        canvas.getContext('2d').drawImage(video, 0, 0);

        const img = document.getElementById('preview');
        img.src = canvas.toDataURL('image/jpeg');
        img.style.display = 'block';
        stream.getTracks().forEach(track => track.stop());

        // === OCULTAR BOTONES DE CÁMARA ===
document.querySelectorAll('.camera-btn').forEach(btn => {
  if (btn.textContent.includes('NEVERA') || btn.textContent.includes('DESPENSA')) {
    btn.style.display = 'none';
  }
});

        // === RULETA ÉPICA: Plato¡GO GO GO! ===
const loading = document.createElement('div');
loading.id = 'loading';
loading.style = `
  text-align: center;
  margin: 20px 0;
  font-weight: 700;
  color: #228B22;
  font-size: 1.2em;
`;
loading.innerHTML = `
  <div style="
    display: inline-block;
    animation: spin 1.2s linear infinite;
    padding: 10px 20px;
    background: #FF4500;
    color: white;
    border-radius: 30px;
    box-shadow: 0 4px 10px rgba(255,69,0,0.4);
  ">
    Plato<span style="color:#FFD700;">¡GO GO GO!</span>
  </div>
`;
document.querySelector('.container').appendChild(loading);


// === BOTÓN SUGERIR PLATO: NARANJA, DEBAJO, CON RULETA ===
let recipeBtn = document.getElementById('suggest-btn');
if (recipeBtn) recipeBtn.remove(); // Elimina duplicados

recipeBtn = document.createElement('button');
recipeBtn.id = 'suggest-btn';
recipeBtn.textContent = 'SUGERIR PLATO';
recipeBtn.style = `
  display: block;
  margin: 20px auto;
  padding: 12px 28px;
  background: linear-gradient(45deg, #FF4500, #FF8C00);
  color: white;
  border: none;
  border-radius: 30px;
  font-weight: 700;
  font-size: 1.1em;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(255,69,0,0.4);
  transition: all 0.2s;
`;
recipeBtn.onmouseover = () => recipeBtn.style.transform = 'scale(1.05)';
recipeBtn.onmouseout = () => recipeBtn.style.transform = 'scale(1)';
recipeBtn.onclick = () => {
  console.log("BOTÓN CLICKADO");
  console.log("INGREDIENTES DETECTADOS:", ingredientsES);
  if (!ingredientsES || ingredientsES.length === 0) {
    addMessage("¡No pillé ingredientes! Haz otra foto.", 'bot');
    return;
  }
  // === RULETA ===
  recipeBtn.innerHTML = `<div style="display:inline-block; animation:spin 1s linear infinite; padding:5px;">Pensando...</div>`;
  recipeBtn.disabled = true;
  suggestRecipe(ingredientsES).finally(() => {
    recipeBtn.innerHTML = 'SUGERIR PLATO';
    recipeBtn.disabled = false;
  });
};

document.querySelector('.container').appendChild(recipeBtn);

// === AÑADE ESTO AL FINAL DEL <script> (UNA VEZ) ===
if (!document.getElementById('platogo-spin')) {
  const style = document.createElement('style');
  style.id = 'platogo-spin';
  style.innerHTML = `
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  `;
  document.head.appendChild(style);
}
// === FIN RULETA ===
        // === AÑADE AQUÍ EL PROMPT DINÁMICO ===
      const promptText = mode === 'pantry' 
        ? "Analiza esta foto de despensa. Detecta arroz, pasta, legumbres, conservas, aceite, especias. Responde: 'Detecté: lista en español separada por comas'."
        : "Analiza esta foto de nevera española. Detecta alimentos y envases. Responde solo: 'Detecté: lista en español separada por comas'.";
      // === FIN ===
        const base64 = canvas.toDataURL('image/jpeg').split(',')[1];

        try {
          // MODELO ACTUAL: gemini-1.5-flash (2025, soporta imágenes + español)
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{
                parts: [
                  {
                    text: promptText
                  },
                  {
                    inline_data: {
                      mime_type: 'image/jpeg',
                      data: base64
                    }
                  }
                ]
              }]
            })
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
          }

          const data = await response.json();
          const analysis = data.candidates[0].content.parts[0].text;

          // === LLENAR ingredientsES GLOBAL ===
const detectedMatch = analysis.match(/Detecté: (.+)/);
if (detectedMatch) {
  ingredientsES = detectedMatch[1].split(',').map(i => i.trim().toLowerCase()).filter(Boolean);
} else {
  ingredientsES = [];
}
console.log("INGREDIENTES DETECTADOS:", ingredientsES); // ← AQUÍ
// === FIN LLENADO ===
          
          document.getElementById('loading').remove();

          if (ingredientsES.length > 0) {
            const result = document.createElement('div');
            result.innerHTML = `
              <p style="margin-top:20px; font-weight:700; color:#228B22;">
                ${analysis}
              </p>
            `;
            document.querySelector('.container').appendChild(result);
   // === MOSTRAR CHAT DESPUÉS DE DETECTAR ===
if (ingredientsES.length > 0) {
  showChat();
}
// === FIN CHAT ===         
// Mostrar chat después de detectar
showChat();


ingredientsES = detected.split(',').map(i => i.trim()).filter(Boolean);
showChat();
          } else {
            const result = document.createElement('div');
            result.innerHTML = `
              <p style="margin-top:20px; color:#DAA520;">
                No detecté alimentos 😅<br>
                <small>Prueba con más luz</small>
              </p>
            `;
            document.querySelector('.container').appendChild(result);
            
          }

        } catch (err) {
          document.getElementById('loading').remove();
          alert(`Error en Gemini: ${err.message}`);
          console.error(err);
        }

      }, 3000);

    } catch (err) {
      alert('Cámara no disponible');
    }
  }

 async function suggestRecipe(ingredients) {
  const modo = currentMode === 'pantry' ? 'despensa' : 'nevera';
 const prompt = `
Eres un chef de barrio, vacilón y directo. Tienes: ${lista} en la ${modo}.
SOLO PUEDES USAR ESO. NADA MÁS.
Sugiere 1 receta corta, en español de barrio, con 1 paso máximo.
Termina siempre con: ", ${getSaludo()}!"
Ejemplos:
- pasta, tomate → "¡Pasta con tomate! Hierve y a zampar, ${getSaludo()}!"
- arroz, pollo → "¡Arroz con pollo! Saltea y a tragar, ${getSaludo()}!"
- pan, tomate → "¡Pan con tomate! Unta y a morder, ${getSaludo()}!"
Si no hay combo: "¡Pilla algo más, ${getSaludo()}!"
`.trim();

  try {
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });
    const data = await res.json();
    const receta = data.candidates[0].content.parts[0].text.trim();
    const noRecipe = document.createElement('div');
    noRecipe.innerHTML = `
      <p style="margin-top:20px; font-weight:700; color:#FF4500;">
        ¡No encontré receta perfecta! 
      </p>
      <p style="font-size:0.9em;">Pero puedes hacer: <strong>${receta}</strong></p>
    `;
    document.querySelector('.container').appendChild(noRecipe);
  } catch {
    addMessage("¡Uy! No pillo... ¿pasta?", 'bot');
  }
}


async function sendChat() {
  const input = document.getElementById('chat-input');
  const message = input.value.trim().toLowerCase();
  if (!message) return;

  addMessage(message, 'user');
  input.value = '';

  // Si no hay ingredientes, no responde
  if (ingredientsES.length === 0) {
    addMessage("Primero haz una foto a la nevera, ¡vamos!", 'bot');
    return;
  }

  // === AÑADE ESTO ANTES DEL PROMPT ===
const modoTexto = currentMode === 'pantry' ? 'despensa' : 'nevera';
  // Prompt ultra-claro
  const prompt = `
Estás en la ${modoTexto} con ESTOS ingredientes EXACTOS (nada más): ${ingredientsES.join(', ')}.
El usuario dice: "${message}".
Responde COMO UN AMIGO DEL BARRIO: vacilón, directo, sin formalismos.
Usa SÓLO lo que tienes. NO inventes. Nada de "proceda", "añada", "sirva".
Si no puedes hacer nada, di: "Con eso, mejor una macedonia o un bocata simple".
Ejemplos reales:
- "¡Echa un chorro de aceite, que no somos pobres!"
- "¡Corta todo como puedas, total se come igual!"
- "¡Tíralo todo junto, remueve y a zampar!"
- "¡No tienes pan? Pues fruta a mordiscos, ¡vamos!"
- "Corta el tomate, mételo en el pan, ¡y a morder!"
- "¡Tira todo en un bol, mézclalo y a disfrutar!"
- "¡Con eso no se hace nada, pero un bocata nunca falla!"
- Si tiene "tomate" y "pan" → "¡Pan con tomate! Unta y a morder."
- Si tiene "plátano", "manzana" → "¡Macedonia! Corta y mezcla."
- Si no encaja → "Con eso, mejor un bocata o fruta directa."
Si es despensa: pasta, arroz, conservas.
Ejemplos:
- "¡Tira fideos al agua, abre tomate en lata, mézclalo y a darle!"
- "¡Con eso haces un arroz tres delicias fácil!"
`.trim();

  try {
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }]
      })
    });
    const data = await res.json();
    const reply = data.candidates[0].content.parts[0].text.trim();
    addMessage(reply, 'bot');
  } catch (err) {
    addMessage("¡Uy! Error de red... ¿bocata?", 'bot');
    console.error(err);
  }
}

function addMessage(text, sender) {
  const messages = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.style = sender === 'user' 
    ? 'text-align:right; margin:8px 0;'
    : 'text-align:left; margin:8px 0;';
  div.innerHTML = `<span style="padding:10px 16px; border-radius:20px; display:inline-block; max-width:85%; font-size:0.95em; ${
    sender === 'user' ? 'background:#FF4500; color:white;' : 'background:#e0e0e0; color:#333;'
  }">${text}</span>`;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

// Mostrar chat cuando haya ingredientes
// === FUNCIÓN SHOWCHAT (AQUÍ) ===

// === CHAT: addMessage + showChat (PEGAR AQUÍ) ===
function addMessage(text, sender) {
  const messages = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.style = sender === 'user' 
    ? 'text-align:right; margin:8px 0;'
    : 'text-align:left; margin:8px 0;';
  div.innerHTML = `<span style="padding:10px 16px; border-radius:20px; display:inline-block; max-width:85%; font-size:0.95em; ${
    sender === 'user' ? 'background:#FF4500; color:white;' : 'background:#e0e0e0; color:#333;'
  }">${text}</span>`;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

function showChat() {
  document.getElementById('chat-container').style.display = 'block';

  const modo = currentMode === 'pantry' ? 'despensa' : 'nevera';
  addMessage(`¡Estoy en la ${modo}! ¿Qué quieres hacer con lo que tienes?`, 'bot');

  // Sugerencia SEGÚN INGREDIENTES
  let sugerencia = '';
  if (currentMode === 'pantry') {
    if (ingredientsES.includes('pasta')) sugerencia = '¿Pasta con tomate en conserva?';
    else if (ingredientsES.includes('arroz')) sugerencia = '¿Arroz tres delicias?';
    else if (ingredientsES.some(i => i.includes('conserva'))) sugerencia = '¿Algo con lata?';
    else sugerencia = '¿Qué te apetece?';
  } else {
    if (ingredientsES.includes('pan') && ingredientsES.includes('tomate')) sugerencia = '¿Bocata de tomate?';
    else if (ingredientsES.some(i => ['plátano', 'manzana', 'naranja'].includes(i))) sugerencia = '¿Macedonia?';
    else if (ingredientsES.includes('tomate') && ingredientsES.includes('cebolla')) sugerencia = '¿Gazpacho?';
    else sugerencia = '¿Qué te apetece?';
  }

  setTimeout(() => addMessage(sugerencia, 'bot'), 1000);
}
// === FIN CHAT ===



  // AÑADIR AL FINAL DEL BODY
  document.body.appendChild(recipeBtn);

  // Opcional: ocultar botones nevera/despensa
  document.querySelectorAll('.camera-btn').forEach(btn => {
    if (btn.textContent.includes('NEVERA') || btn.textContent.includes('DESPENSA')) {
      btn.style.display = 'none';
    }
  });



// === FUNCIÓN PARA PALABRAS SEGÚN GÉNERO ===
function getWord(male, female) {
  return userGender === 'mujer' ? female : male;
}
// === PREGUNTA DE GÉNERO: ENCIMA DE LOS BOTONES (ANTES DE FOTO) ===
document.addEventListener('DOMContentLoaded', () => {
  const savedGender = localStorage.getItem('platogo_gender');

  if (!savedGender) {
    // === CREAR PANTALLA DE PREGUNTA ===
    const genderOverlay = document.createElement('div');
    genderOverlay.id = 'gender-overlay';
    genderOverlay.style = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, #FF4500, #FF8C00);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      color: white; font-family: sans-serif; text-align: center; z-index: 9999;
      padding: 20px; box-sizing: border-box;
    `;
    genderOverlay.innerHTML = `
      <h1 style="font-size: 2.2em; margin-bottom: 10px;">¡Ey, chef! 😎</h1>
      <p style="font-size: 1.2em; margin-bottom: 30px;">¿Eres más de <strong>crack</strong>, <strong>tía</strong> o <strong>mezcla</strong>?</p>
      <div>
        <button onclick="saveGender('hombre')" class="gender-big-btn">CRACK</button>
        <button onclick="saveGender('mujer')" class="gender-big-btn female">TÍA</button>
        <button onclick="saveGender('mixto')" class="gender-big-btn mix">MEZCLA</button>
      </div>
    `;
    document.body.appendChild(genderOverlay);
  }
});

// === GUARDAR GÉNERO Y QUITAR PANTALLA ===
function saveGender(g) {
  localStorage.setItem('platogo_gender', g);
  const overlay = document.getElementById('gender-overlay');
  if (overlay) overlay.remove();

  // Mensaje de bienvenida en el chat
  const welcome = g === 'hombre' ? '¡Crack en la cocina! 🔥' :
                 g === 'mujer' ? '¡Tía al mando! 💅' :
                 '¡Mezcla total, vamos a romperla! 🌈';
  addMessage(welcome, 'bot');
  addMessage('¡Haz una foto y te digo qué cocinar!', 'bot');
}

// === OBTENER SALUDO ===
function getSaludo() {
  const g = localStorage.getItem('platogo_gender');
  if (g === 'mujer') return 'tía';
  if (g === 'hombre') return 'crack';
  return 'crack o tía';
}
// === SCROLL AL FINAL DEL CHAT (ALWAYS VISIBLE) ===
function scrollChat() {
  const chat = document.getElementById('chat-messages');
  if (chat) {
    chat.scrollTop = chat.scrollHeight;
  }
}
</script>


</div>
<!-- === CHAT DE RECETAS (AQUÍ) === -->
<div id="chat-container" style="margin:30px 0 20px; display:none;">
  <div id="chat-messages" style="height:220px; overflow-y:auto; padding:15px; background:#f9f9f9; border-radius:18px; margin-bottom:12px; font-family:system-ui;"></div>
  <div style="display:flex; gap:8px;">
    <input type="text" id="chat-input" placeholder="Pide tu receta: bocata, macedonia..." style="flex:1; padding:14px; border-radius:14px; border:1px solid #ddd; font-size:1em;">
    <button onclick="sendChat()" style="padding:14px 18px; background:#FF4500; color:white; border:none; border-radius:14px; font-weight:700; cursor:pointer;">¡VAMOS!</button>
  </div>
</div>
<!-- === FIN CHAT === -->
<!-- === FIN CHAT === -->
</body>
</html>